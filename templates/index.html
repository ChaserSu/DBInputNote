<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网文分段编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #4a90e2;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .project-info {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #4a90e2;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #357abd;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
        }
        
        .paragraphs-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .paragraph {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .paragraph:hover {
            border-color: #4a90e2;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
        }
        
        .paragraph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .paragraph-number {
            font-weight: 600;
            color: #4a90e2;
            font-size: 16px;
        }
        
        .paragraph-actions {
            display: flex;
            gap: 5px;
        }
        
        .paragraph-actions .btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .paragraph-content {
            margin-bottom: 10px;
        }
        
        .paragraph-text {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .paragraph-text:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        
        .recording-status {
            font-size: 12px;
            color: #e74c3c;
            margin-left: 10px;
        }
        
        .recording-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .recording-active {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .audio-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>网文分段编辑器</h1>
        </div>
    </header>
    
    <div class="container">
        <div id="status-message" class="status-message" style="display: none;"></div>
        
        <div class="project-info">
            <div class="project-actions">
                <div class="input-group">
                    <input type="text" id="project-name" placeholder="项目名称">
                    <button class="btn btn-primary" onclick="createProject()">新建项目</button>
                    <button class="btn btn-secondary" onclick="loadProject()">打开项目</button>
                </div>
            </div>
            <div id="project-details" style="display: none;">
                <strong>当前项目:</strong> <span id="current-project-name"></span>
            </div>
        </div>
        
        <div class="paragraphs-container">
            <div id="empty-state" class="empty-state">
                <h3>暂无段落</h3>
                <p>请先创建或打开一个项目</p>
            </div>
            <div id="paragraphs-list"></div>
        </div>
    </div>
    
    <script>
        let currentProject = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingParagraphId = null;
        
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${isSuccess ? 'success' : 'error'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function createProject() {
            const projectName = document.getElementById('project-name').value || '未命名项目';
            
            fetch('/api/project/new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: projectName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProject = data.project;
                    updateProjectInfo();
                    renderParagraphs();
                    showStatus('项目创建成功');
                } else {
                    showStatus('项目创建失败: ' + data.message, false);
                }
            })
            .catch(error => {
                showStatus('创建项目时发生错误', false);
                console.error('Error:', error);
            });
        }
        
        function loadProject() {
            // 这里简化处理，实际应该显示项目列表供选择
            showStatus('项目加载功能待实现', false);
        }
        
        function updateProjectInfo() {
            if (currentProject) {
                document.getElementById('project-details').style.display = 'block';
                document.getElementById('current-project-name').textContent = currentProject.name;
                document.getElementById('empty-state').style.display = 'none';
            } else {
                document.getElementById('project-details').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
            }
        }
        
        function renderParagraphs() {
            if (!currentProject || !currentProject.paragraphs) {
                return;
            }
            
            const container = document.getElementById('paragraphs-list');
            container.innerHTML = '';
            
            currentProject.paragraphs.forEach((paragraph, index) => {
                const paragraphDiv = document.createElement('div');
                paragraphDiv.className = 'paragraph';
                paragraphDiv.innerHTML = `
                    <div class="paragraph-header">
                        <div class="paragraph-number">段落 ${index + 1}</div>
                        <div class="paragraph-actions">
                            ${index > 0 ? `<button class="btn btn-secondary" onclick="moveParagraph('${paragraph.id}', 'up')">↑</button>` : ''}
                            ${index < currentProject.paragraphs.length - 1 ? `<button class="btn btn-secondary" onclick="moveParagraph('${paragraph.id}', 'down')">↓</button>` : ''}
                            <button class="btn btn-danger" onclick="deleteParagraph('${paragraph.id}')">删除</button>
                        </div>
                    </div>
                    <div class="paragraph-content">
                        <textarea class="paragraph-text" id="text-${paragraph.id}" placeholder="请输入段落内容..." oninput="saveParagraph('${paragraph.id}')" onkeydown="handleKeyDown(event, '${paragraph.id}')">${paragraph.text}</textarea>
                    </div>
                    <div class="recording-controls">
                        <button class="btn ${paragraph.audio ? 'btn-success' : 'btn-primary'}" onclick="${paragraph.audio ? `playAudio('${paragraph.id}', '${paragraph.audio}')` : `startRecording('${paragraph.id}')`}">
                            ${paragraph.audio ? '播放录音' : '开始录音'}
                        </button>
                        ${paragraph.audio ? `<button class="btn btn-secondary" onclick="deleteAudio('${paragraph.id}')">删除录音</button>` : ''}
                        <button class="btn btn-secondary" id="stop-btn-${paragraph.id}" onclick="stopRecording()" style="display: none;">停止录音</button>
                        <span id="recording-status-${paragraph.id}" class="recording-status"></span>
                    </div>
                    ${paragraph.audio ? `<div class="audio-info">已有录音文件</div>` : ''}
                `;
                container.appendChild(paragraphDiv);
            });
        }
        
        function addParagraph(text = '') {
            fetch('/api/paragraph/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProject.paragraphs.push(data.paragraph);
                    renderParagraphs();
                    // 聚焦到新段落
                    setTimeout(() => {
                        document.getElementById(`text-${data.paragraph.id}`).focus();
                    }, 100);
                }
            })
            .catch(error => {
                console.error('Error adding paragraph:', error);
            });
        }
        
        function saveParagraph(paragraphId) {
            const textarea = document.getElementById(`text-${paragraphId}`);
            const text = textarea.value;
            
            fetch('/api/paragraph/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: paragraphId, text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新本地数据
                    const paragraph = currentProject.paragraphs.find(p => p.id === paragraphId);
                    if (paragraph) {
                        paragraph.text = text;
                    }
                }
            })
            .catch(error => {
                console.error('Error saving paragraph:', error);
            });
        }
        
        function deleteParagraph(paragraphId) {
            if (confirm('确定要删除这个段落吗？')) {
                fetch(`/api/paragraph/delete/${paragraphId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新本地数据
                        currentProject.paragraphs = currentProject.paragraphs.filter(p => p.id !== paragraphId);
                        renderParagraphs();
                        showStatus('段落删除成功');
                    }
                })
                .catch(error => {
                    console.error('Error deleting paragraph:', error);
                });
            }
        }
        
        function moveParagraph(paragraphId, direction) {
            fetch(`/api/paragraph/move/${paragraphId}/${direction}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProject.paragraphs = data.paragraphs;
                    renderParagraphs();
                }
            })
            .catch(error => {
                console.error('Error moving paragraph:', error);
            });
        }
        
        function handleKeyDown(event, paragraphId) {
            // 检测 Enter 键（普通回车新建段落）
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                
                // 获取当前文本框内容
                const textarea = document.getElementById(`text-${paragraphId}`);
                const text = textarea.value;
                
                // 保存当前段落
                saveParagraph(paragraphId);
                
                // 添加新段落
                addParagraph();
            }
            // Shift+Enter 在当前文本框内换行（保持原有功能）
            else if (event.key === 'Enter' && event.shiftKey) {
                // 允许默认行为，在当前文本框内换行
            }
        }
        
        function startRecording(paragraphId) {
            // 停止之前的录音
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            recordingParagraphId = paragraphId;
            
            // 更新UI
            document.getElementById(`stop-btn-${paragraphId}`).style.display = 'inline-block';
            document.getElementById(`recording-status-${paragraphId}`).textContent = '录音中...';
            document.getElementById(`recording-status-${paragraphId}`).className = 'recording-status recording-active';
            
            // 开始录音
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        uploadAudio(paragraphId, audioBlob);
                    };
                    
                    mediaRecorder.start();
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    showStatus('无法访问麦克风，请检查权限设置', false);
                    stopRecording();
                });
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                // 停止所有音轨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            // 重置UI
            if (recordingParagraphId) {
                document.getElementById(`stop-btn-${recordingParagraphId}`).style.display = 'none';
                document.getElementById(`recording-status-${recordingParagraphId}`).textContent = '';
                document.getElementById(`recording-status-${recordingParagraphId}`).className = 'recording-status';
            }
            
            recordingParagraphId = null;
        }
        
        function uploadAudio(paragraphId, audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');
            
            fetch(`/api/audio/upload/${paragraphId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新本地数据
                    const paragraph = currentProject.paragraphs.find(p => p.id === paragraphId);
                    if (paragraph) {
                        paragraph.audio = data.paragraph.audio;
                    }
                    renderParagraphs();
                    showStatus('录音保存成功');
                }
            })
            .catch(error => {
                console.error('Error uploading audio:', error);
                showStatus('录音保存失败', false);
            });
        }
        
        function playAudio(paragraphId, audioFilename) {
            const audioUrl = `/api/audio/${currentProject.id}/${audioFilename}`;
            const audio = new Audio(audioUrl);
            audio.play();
        }
        
        function deleteAudio(paragraphId) {
            // 简单实现，实际应该调用API删除
            const paragraph = currentProject.paragraphs.find(p => p.id === paragraphId);
            if (paragraph) {
                paragraph.audio = '';
                renderParagraphs();
                showStatus('录音删除成功');
            }
        }
    </script>
</body>
</html>